<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulacro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #0049c6; --bg: #f4f6f9; --text: #333; --correct: #28a745; --wrong: #d9534f; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER */
        .top-bar { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; }
        .timer { font-weight: 800; color: #d9534f; font-size: 18px; display: flex; align-items: center; gap: 5px; }
        
        .btn-finish { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .btn-exit-review { background: #6c757d !important; }

        /* BODY */
        .main-container { display: flex; flex: 1; overflow: hidden; }

        .nav-panel { width: 60px; background: white; border-right: 1px solid #eee; overflow-y: auto; padding: 10px 5px; display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; }
        .q-indicator { 
            width: 35px; height: 35px; border-radius: 50%; background: #f0f0f0; 
            color: #666; font-size: 12px; font-weight: bold; display: flex; 
            justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0;
            border: 2px solid transparent; transition: 0.2s;
        }
        .q-indicator.active { border-color: var(--primary); transform: scale(1.1); }
        .q-indicator.answered { background: #e0f0ff; color: var(--primary); font-weight: 900; }
        
        .q-indicator.rev-correct { background: var(--correct); color: white; }
        .q-indicator.rev-wrong { background: var(--wrong); color: white; }

        .question-area { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .course-tag { background: #eee; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 10px; display: inline-block; }
        
        .points-tag { float: right; background: #fff3cd; color: #856404; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-left: 10px; font-weight: bold; }

        .q-text { font-size: 16px; line-height: 1.5; color: #333; margin-bottom: 20px; font-weight: 500; }
        .q-img { max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 15px; display: none; border: 1px solid #eee; }

        .options-list { display: flex; flex-direction: column; gap: 10px; }
        .option-item { 
            display: flex; align-items: center; padding: 12px 15px; 
            background: white; border: 1px solid #ddd; border-radius: 10px; 
            cursor: pointer; transition: 0.2s; 
        }
        .option-item.selected { background: #e0f0ff; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .opt-circle { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; margin-right: 15px; display: flex; justify-content: center; align-items: center; }
        .selected .opt-circle { border-color: var(--primary); background: var(--primary); }

        .option-item.correct-ans { border-color: var(--correct); background: #d4edda; color: var(--correct); }
        .option-item.wrong-ans { border-color: var(--wrong); background: #f8d7da; color: var(--wrong); }

        .bottom-nav { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-between; }
        .nav-btn { background: #0049c6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .nav-btn:disabled { background: #ccc; cursor: default; }

        /* MODALES */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
        
        .modal-content { 
            background: white; padding: 25px; border-radius: 15px; text-align: center; 
            width: 90%; max-width: 350px; 
            max-height: 85vh; 
            display: flex; flex-direction: column; 
        }

        .score-circle { width: 100px; height: 100px; border-radius: 50%; border: 5px solid var(--primary); display: flex; justify-content: center; align-items: center; margin: 0 auto 20px; font-size: 24px; font-weight: 900; color: var(--primary); flex-shrink: 0;}
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; flex-shrink: 0;}
        .btn-action { padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 13px; }
        
        /* RANKING LIST */
        .ranking-scroll-area {
            overflow-y: auto;
            flex: 1;
            margin: 15px 0;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 5px;
        }

        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; align-items: center; }
        .rank-pos { width: 28px; height: 28px; background: #eee; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 10px; font-size: 12px; }
        .rank-1 { background: #ffcc00; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .rank-2 { background: #c0c0c0; color: white; }
        .rank-3 { background: #cd7f32; color: white; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="font-size:14px; font-weight:bold;">Simulacro</div>
        <div class="timer" id="timerBox"><i class="far fa-clock"></i> <span id="timeDisplay">00:00:00</span></div>
        <button class="btn-finish" id="btnFinish" onclick="confirmFinish()">TERMINAR</button>
    </div>

    <div class="main-container">
        <div class="nav-panel" id="navPanel"></div>

        <div class="question-area">
            <span class="points-tag" id="qPoints">...</span>
            <span class="course-tag" id="qCourse">...</span>
            <div style="float:right; color:#999; font-size:12px; margin-right: 10px;">Pregunta <span id="qNumDisplay">1</span></div>
            <br>
            <div id="feedbackMsg" style="display:none; padding:10px; margin-bottom:15px; border-radius:8px; font-weight:bold; font-size:14px;"></div>
            <p class="q-text" id="qText">...</p>
            <img src="" class="q-img" id="qImg">
            <div class="options-list" id="optionsBox"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn" id="btnPrev" onclick="moveQ(-1)"><i class="fas fa-chevron-left"></i></button>
        <button class="nav-btn" id="btnNext" onclick="moveQ(1)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Resultados</h2>
            <div class="score-circle" id="finalScore">0</div>
            <p id="examNameResult" style="color:#666; font-size:14px; margin-bottom:15px;"></p>
            
            <div style="text-align:left; font-size:14px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>‚úÖ Correctas:</span> <strong id="resOk" style="color:#28a745">0</strong></div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>‚ùå Incorrectas:</span> <strong id="resFail" style="color:#d9534f">0</strong></div>
                <div style="display:flex; justify-content:space-between;"><span>‚ö™ En blanco:</span> <strong id="resBlank" style="color:#666">0</strong></div>
            </div>

            <div class="action-grid">
                <button class="btn-action" style="background:#0049c6;" onclick="startReview()">üëÅÔ∏è REVISAR</button>
                <button class="btn-action" style="background:#ffcc00; color:#333;" onclick="showRanking()">üèÜ RANKING</button>
            </div>
            <button class="nav-btn" style="width:100%; justify-content:center; margin-top:10px; background:#eee; color:#333;" onclick="exitExam()">SALIR</button>
        </div>
    </div>

    <div id="rankModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#0049c6; margin-top:0; flex-shrink: 0;">üèÜ Top Estudiantes</h3>
            <p style="font-size:12px; color:#666; margin:0; flex-shrink: 0;" id="rankSubtitle">Cargando...</p>
            
            <div class="ranking-scroll-area" id="rankList"></div>
            
            <button class="nav-btn" style="width:100%; justify-content:center; flex-shrink: 0;" onclick="document.getElementById('rankModal').style.display='none'">Cerrar</button>
        </div>
    </div>

    <script src="banco_admision.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyiV4L51lYJ_-P5MrOVyMmJVgKwHsLRn0s3ZQy6GBd8Bc0DEzresGu_0fzwAv10YCL9fw/exec";
        
        let examData, userAnswers, timerInterval, secondsLeft, examID;
        let currentQ = 0;
        let isReviewMode = false;

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            examID = params.get('id');

            if (!examID || !bancoAdmision[examID]) {
                alert("Examen no encontrado");
                return window.location.href = "universidades.html";
            }

            examData = bancoAdmision[examID];
            
            const saved = localStorage.getItem('simulacro_' + examID);
            if (saved) {
                const state = JSON.parse(saved);
                userAnswers = state.answers;
                secondsLeft = state.time;
                currentQ = state.current;
            } else {
                userAnswers = new Array(examData.preguntas.length).fill(null);
                secondsLeft = examData.tiempo * 60;
            }

            initInterface();
            startTimer();
            loadQuestion(currentQ);
        });

        function initInterface() {
            const nav = document.getElementById('navPanel');
            nav.innerHTML = "";
            examData.preguntas.forEach((_, idx) => {
                const ball = document.createElement('div');
                ball.className = 'q-indicator';
                ball.innerText = idx + 1;
                ball.onclick = () => loadQuestion(idx);
                ball.id = 'ball-' + idx;
                nav.appendChild(ball);
            });
            updateNavStatus();
        }

        function loadQuestion(index) {
            currentQ = index;
            const q = examData.preguntas[index];
            const myAns = userAnswers[index];

            document.getElementById('qCourse').innerText = q.curso;
            document.getElementById('qNumDisplay').innerText = index + 1;
            document.getElementById('qText').innerText = q.texto;
            
            const pts = (q.puntos && q.puntos.correcta) ? q.puntos.correcta : examData.puntos.correcta;
            document.getElementById('qPoints').innerText = pts + " pts";

            const imgEl = document.getElementById('qImg');
            if(q.img) { imgEl.src = q.img; imgEl.style.display = 'block'; }
            else { imgEl.style.display = 'none'; }

            const fb = document.getElementById('feedbackMsg');
            if(isReviewMode) {
                fb.style.display = 'block';
                if(myAns === q.correcta) {
                    fb.style.background = '#d4edda'; fb.style.color = '#155724'; fb.innerText = "‚úÖ ¬°Respuesta Correcta!";
                } else if(myAns === null) {
                    fb.style.background = '#fff3cd'; fb.style.color = '#856404'; fb.innerText = "‚ö™ No respondiste esta pregunta.";
                } else {
                    fb.style.background = '#f8d7da'; fb.style.color = '#721c24'; fb.innerText = "‚ùå Respuesta Incorrecta.";
                }
            } else {
                fb.style.display = 'none';
            }

            const optsBox = document.getElementById('optionsBox');
            optsBox.innerHTML = "";
            
            q.opciones.forEach((opt, i) => {
                const item = document.createElement('div');
                let classes = 'option-item';
                
                if (isReviewMode) {
                    if (i === q.correcta) classes += ' correct-ans';
                    if (i === myAns && i !== q.correcta) classes += ' wrong-ans';
                } else {
                    if (myAns === i) classes += ' selected';
                }

                item.className = classes;
                item.innerHTML = `<div class="opt-circle"></div> <div>${opt}</div>`;
                if (!isReviewMode) item.onclick = () => selectOption(i);
                optsBox.appendChild(item);
            });

            document.getElementById('btnPrev').disabled = (index === 0);
            document.querySelectorAll('.q-indicator').forEach(b => b.classList.remove('active'));
            document.getElementById('ball-'+index).classList.add('active');
            
            if(!isReviewMode) saveProgress();
        }

        function selectOption(i) {
            userAnswers[currentQ] = i;
            updateNavStatus();
            loadQuestion(currentQ);
        }

        function updateNavStatus() {
            userAnswers.forEach((ans, idx) => {
                const ball = document.getElementById('ball-' + idx);
                if(isReviewMode) {
                    const isOk = (ans === examData.preguntas[idx].correcta);
                    if(ans !== null) ball.classList.add(isOk ? 'rev-correct' : 'rev-wrong');
                } else {
                    if (ans !== null) ball.classList.add('answered');
                    else ball.classList.remove('answered');
                }
            });
        }

        function moveQ(dir) {
            const next = currentQ + dir;
            if (next >= 0 && next < examData.preguntas.length) loadQuestion(next);
        }

        function saveProgress() {
            localStorage.setItem('simulacro_' + examID, JSON.stringify({
                answers: userAnswers, time: secondsLeft, current: currentQ
            }));
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                secondsLeft--;
                if (secondsLeft <= 0) finishExam();
                const hrs = Math.floor(secondsLeft/3600).toString().padStart(2,'0');
                const mins = Math.floor((secondsLeft%3600)/60).toString().padStart(2,'0');
                const secs = (secondsLeft%60).toString().padStart(2,'0');
                document.getElementById('timeDisplay').innerText = `${hrs}:${mins}:${secs}`;
            }, 1000);
        }

        function confirmFinish() {
            if(isReviewMode) {
                exitExam();
            } else {
                if(confirm("¬øTerminar simulacro?")) finishExam();
            }
        }

        function finishExam() {
            clearInterval(timerInterval);
            isReviewMode = true; 
            
            let score = 0, ok = 0, fail = 0, blank = 0;
            const globalRules = examData.puntos;

            examData.preguntas.forEach((q, idx) => {
                const pCorrect = (q.puntos && q.puntos.correcta !== undefined) ? q.puntos.correcta : globalRules.correcta;
                const pWrong = (q.puntos && q.puntos.incorrecta !== undefined) ? q.puntos.incorrecta : globalRules.incorrecta;
                const pBlank = (q.puntos && q.puntos.vacia !== undefined) ? q.puntos.vacia : (globalRules.vacia || 0);

                const ans = userAnswers[idx];
                if (ans === null) { 
                    score += pBlank; 
                    blank++; 
                } else if (ans === q.correcta) { 
                    score += pCorrect; 
                    ok++; 
                } else { 
                    score += pWrong; 
                    fail++; 
                }
            });

            // Redondear a 2 decimales y evitar negativos visuales
            score = Math.round(score * 100) / 100;
            const finalDisplayScore = Math.max(0, score);

            document.getElementById('finalScore').innerText = finalDisplayScore;
            document.getElementById('examNameResult').innerText = examData.titulo;
            document.getElementById('resOk').innerText = ok;
            document.getElementById('resFail').innerText = fail;
            document.getElementById('resBlank').innerText = blank;
            document.getElementById('resultModal').style.display = 'flex';
            document.getElementById('timerBox').style.display = 'none';
            
            const btnTop = document.getElementById('btnFinish');
            btnTop.innerText = "SALIR";
            btnTop.classList.add('btn-exit-review');
            btnTop.onclick = exitExam;

            localStorage.removeItem('simulacro_' + examID);
            
            // --- ENV√çO AL BACKEND (L√≥gica High Score) ---
            const myID = localStorage.getItem('xAcademy_ID');
            // Intentar obtener el nombre guardado, si no, usa 'Estudiante'
            const myName = localStorage.getItem('xAcademy_Name') || "Estudiante"; 

            if (myID) {
                // Usamos POST para enviar datos complejos
                fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=saveExamScore&id=${encodeURIComponent(myID)}&nombre=${encodeURIComponent(myName)}&curso=${encodeURIComponent(examID)}&puntaje=${finalDisplayScore}`
                });
            }
        }

        function startReview() {
            document.getElementById('resultModal').style.display = 'none';
            updateNavStatus();
            loadQuestion(0);
        }

        function showRanking() {
            document.getElementById('rankModal').style.display = 'flex';
            fetchRanking(examID);
        }

        function fetchRanking(id) {
            document.getElementById('rankSubtitle').innerText = "Cargando ranking...";
            const list = document.getElementById('rankList');
            list.innerHTML = "";
            
            fetch(`${API_URL}?action=getRanking&curso=${encodeURIComponent(id)}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('rankSubtitle').innerText = "Top 30 - " + (bancoAdmision[id]?.titulo || "");
                if(data.length === 0) list.innerHTML = "<p align='center'>S√© el primero en el ranking.</p>";
                
                data.forEach((u, i) => {
                    let colorClass = '';
                    if(i===0) colorClass = 'rank-1';
                    else if(i===1) colorClass = 'rank-2';
                    else if(i===2) colorClass = 'rank-3';

                    list.innerHTML += `
                        <div class="rank-item">
                            <div style="display:flex;align-items:center;">
                                <div class="rank-pos ${colorClass}">${i+1}</div> 
                                <span style="font-weight:500;">${u.nombre}</span>
                            </div>
                            <strong style="color:var(--primary);">${u.xp} pts</strong>
                        </div>`;
                });
            });
        }

        function exitExam() { window.location.href = "universidades.html"; }
    </script>
</body>
</html>